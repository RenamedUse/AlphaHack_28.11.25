# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–æ—É: CSV ‚Üí –ü—Ä–æ–≥–Ω–æ–∑ ‚Üí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

## ‚úÖ –í–µ—Å—å —Ñ–ª–æ—É –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û

---

## 1. –ó–ê–ì–†–£–ó–ö–ê CSV –§–ê–ô–õ–ê

### Endpoint: `POST /api/imports/income-csv`

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- CSV —Ñ–∞–π–ª —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: `external_id`, ...–ø—Ä–∏–∑–Ω–∞–∫–∏...
- –ü—Ä–∏–º–µ—Ä:
  ```csv
  external_id,age,income_category,region
  client_001,35,middle,moscow
  client_002,42,high,spb
  ```

**–ü—Ä–æ—Ü–µ—Å—Å:**
```
1. –§–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ IMPORTS_PATH (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é /tmp/imports)
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å ImportJob –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "queued"
3. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ process_import_job
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è response —Å job.id –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å UUID –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
- ImportJob –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î
- –ó–∞–¥–∞—á–∞ —Å—Ç–∞–≤–∏—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤—É—é –æ—á–µ—Ä–µ–¥—å

---

## 2. –§–û–ù–û–í–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê CSV

### –§—É–Ω–∫—Ü–∏—è: `process_import_job(job_id: int)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

```
CSV –ß–∏—Ç–∞–µ—Ç—Å—è –ø–æ—Å—Ç—Ä–æ—á–Ω–æ:
  ‚îú‚îÄ –ü–∞—Ä—Å–∏–Ω–≥: csv.DictReader
  ‚îú‚îÄ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: canonicalize_features()
  ‚îÇ  ‚îî‚îÄ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ —á–∏—Å–ª–∞ (—Å –∑–∞–ø—è—Ç–æ–π –Ω–∞ —Ç–æ—á–∫—É)
  ‚îú‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ Client –ø–æ external_id
  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏? (hash —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
  ‚îî‚îÄ –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å:
      ‚îú‚îÄ –í—ã–∑–æ–≤ model.predict() ‚Üê ML –ú–û–î–ï–õ–¨
      ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PredictionLog
      ‚îú‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ClientState
      ‚îî‚îÄ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: compute_recommendations()
```

**–°—Ç–∞—Ç—É—Å—ã ImportJob:**
- `queued` ‚Üí (–∑–∞–¥–∞—á–∞ –≤ –æ—á–µ—Ä–µ–¥–∏)
- `running` ‚Üí (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
- `completed` ‚Üí (—É—Å–ø–µ—à–Ω–æ, –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã)
- `failed` ‚Üí (–æ—à–∏–±–∫–∞, —Ç–µ–∫—Å—Ç –≤ job.error)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ö–æ–¥ —Å—Ç—Ä–æ–∫ CSV
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ processed_rows –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

## 3. ML –ú–û–î–ï–õ–¨ –ü–†–ï–î–°–ö–ê–ó–ê–ù–ò–Ø

### –ö–ª–∞—Å—Å: `IncomeModel` (app/ml/model.py)

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```python
features = {
    'age': 35,
    'income_category': 'middle',
    'region': 'moscow',
    # ... –µ—â–µ 216 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏–∑ preprocessor.pkl
}
```

**–ü—Ä–æ—Ü–µ—Å—Å:**

```
1. –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤:
   ‚îú‚îÄ MODEL_PATH: c:/Dev/.../app/ml/income_prediction_model.pkl (XGBoost Booster)
   ‚îî‚îÄ PREPROCESSOR_PATH: c:/Dev/.../app/ml/preprocessor.pkl (220 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤)

2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:
   ‚îú‚îÄ –¶–∏–∫–ª –ø–æ 220 –ø—Ä–∏–∑–Ω–∞–∫–∞–º
   ‚îú‚îÄ –ï—Å–ª–∏ –ø—Ä–∏–∑–Ω–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: -999.0 (NA)
   ‚îú‚îÄ –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞: hash() % 1000
   ‚îî‚îÄ –ò—Ç–æ–≥: numpy array (1, 220)

3. –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ:
   ‚îú‚îÄ XGBoost Booster.predict(DMatrix) ‚Üí income_pred
   ‚îî‚îÄ –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 60,348 ‚ÇΩ

4. –û–±—ä—è—Å–Ω–µ–Ω–∏–µ (SHAP):
   ‚îú‚îÄ TreeExplainer.shap_values() ‚Üí –º–∞—Å—Å–∏–≤ –≤–∫–ª–∞–¥–æ–≤
   ‚îú‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –µ—Å–ª–∏ SHAP –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω—É–ª–∏
   ‚îî‚îÄ –¢–æ–ø-10 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ø–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–º—É –≤–∫–ª–∞–¥—É

5. –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:
   ‚îî‚îÄ "–ú–æ–¥–µ–ª—å –æ—Ü–µ–Ω–∏–ª–∞ –¥–æ—Ö–æ–¥ –≤ 60,348 ‚ÇΩ. 
       –ù–∞–∏–±–æ–ª—å—à–∏–π –≤–∫–ª–∞–¥ –¥–∞–ª–∏: feature_1 (value1) +5000 ‚ÇΩ, ..."
```

**–¢–µ—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ:**
```
Input: {'age': 35}
Output: 
  - income_pred: 60,348 ‚ÇΩ
  - top_features: 10 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  - text_explanation: –≥–æ—Ç–æ–≤ –∫ –≤—ã–≤–æ–¥—É
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è (XGBoost Booster)
- Preprocessor —Å–æ–¥–µ—Ä–∂–∏—Ç 220 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
- –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- SHAP –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (—Å fallback –Ω–∞ –Ω—É–ª–∏)

---

## 4. –í–´–ß–ò–°–õ–ï–ù–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô

### –§—É–Ω–∫—Ü–∏—è: `compute_recommendations(db, income_pred, features)`

**–ü—Ä–æ—Ü–µ—Å—Å:**

```
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç –ø–æ –¥–æ—Ö–æ–¥—É:
   ‚îú‚îÄ –ù–∞–π—Ç–∏ Segment –≥–¥–µ min_income <= 60,348 < max_income
   ‚îî‚îÄ –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "middle" (50k-120k)

2. –ù–∞–π—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞:
   ‚îú‚îÄ SELECT Product JOIN ProductSegment
   ‚îÇ  WHERE Product.active = TRUE
   ‚îÇ  AND segment.id = ?
   ‚îÇ  AND (Product.min_income IS NULL OR income >= Product.min_income)
   ‚îÇ  AND (Product.max_income IS NULL OR income <= Product.max_income)
   ‚îî‚îÄ –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç: [Product1, Product2, Product3]

3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞:
   ‚îú‚îÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å ProductFeatureRule (WHERE feature_id, operator, value_text)
   ‚îú‚îÄ –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞:
   ‚îÇ  ‚îú‚îÄ –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∞ –∏–∑ features[feature_name]
   ‚îÇ  ‚îú‚îÄ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä (eq, ne, lt, le, gt, ge)
   ‚îÇ  ‚îî‚îÄ –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –Ω–µ –ø—Ä–æ—à–ª–æ: product –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
   ‚îî‚îÄ –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—à–ª–∏: –¥–æ–±–∞–≤–∏—Ç—å –≤ recommendations

4. –í–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫:
   [
     {
       "code": "product_code",
       "name": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞",
       "description": "–û–ø–∏—Å–∞–Ω–∏–µ",
       "reason": "–ü—Ä–∏—á–∏–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"
     },
     ...
   ]
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–∞ –ø–æ –¥–æ—Ö–æ–¥—É
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ min/max –¥–æ—Ö–æ–¥—É
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª (feature rules checking)

---

## 5. –ü–û–õ–£–ß–ï–ù–ò–ï –ö–ê–†–¢–û–ß–ö–ò –ö–õ–ò–ï–ù–¢–ê

### Endpoint: `GET /api/clients/{external_id}/card`

**–ü—Ä–æ—Ü–µ—Å—Å:**

```
1. –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ external_id
   ‚îî‚îÄ SELECT Client WHERE external_id = ?

2. –ü–æ–ª—É—á–∏—Ç—å ClientState (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑)
   ‚îî‚îÄ –¢–µ–∫—É—â–∏–π –¥–æ—Ö–æ–¥, –ø—Ä–∏–∑–Ω–∞–∫–∏, –≤–µ—Ä—Å–∏—è –º–æ–¥–µ–ª–∏

3. –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π PredictionLog (–Ω–µ —Å–∏–º—É–ª—è—Ü–∏—è)
   ‚îú‚îÄ explanation_json (SHAP –≤–∫–ª–∞–¥—ã)
   ‚îî‚îÄ text_explanation (–≥–æ—Ç–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ)

4. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç
   ‚îî‚îÄ SELECT Segment WHERE min_income <= income < max_income

5. –í—ã—á–∏—Å–ª–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
   ‚îî‚îÄ compute_recommendations()

6. –í–µ—Ä–Ω—É—Ç—å CardResponse:
   {
     "client": {
       "external_id": "client_001",
       "display_name": "client_001",
       "created_at": "2025-11-30T12:00:00Z"
     },
     "prediction": {
       "income_pred": 60348.0,
       "segment_code": "middle",
       "segment_name": "–°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥",
       "model_version": "v1",
       "updated_at": "2025-11-30T12:05:00Z"
     },
     "explanation": {
       "baseline_income": 57450.0,
       "prediction": 60348.0,
       "top_features": [
         {
           "feature": "feature_1",
           "title": "feature_1",
           "value": 100.5,
           "shap_value": 2898.0
         },
         ...
       ],
       "text": "–ú–æ–¥–µ–ª—å –æ—Ü–µ–Ω–∏–ª–∞ –¥–æ—Ö–æ–¥ –≤ 60,348 ‚ÇΩ. ..."
     },
     "products": [
       {
         "code": "product_1",
         "name": "–ö—Ä–µ–¥–∏—Ç –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–ª–∞—Å—Å–∞",
         "description": "...",
         "reason": "–°–µ–≥–º–µ–Ω—Ç middle –∏ –¥–æ—Ö–æ–¥ 60k –ø–æ–¥—Ö–æ–¥—è—Ç —É—Å–ª–æ–≤–∏—è–º"
       },
       ...
     ]
   }
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- –í—Å–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –≤ –ë–î –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (relationships)
- –î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü

---

## üìä–í–ï–° –î–ê–ù–ù–´–• –ü–û–°–õ–ï –ò–ú–ü–û–†–¢–ê CSV

–î–ª—è 1 —Å—Ç—Ä–æ–∫–∏ CSV —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:

1. **Client** (1 –∑–∞–ø–∏—Å—å):
   - external_id (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
   - display_name
   - created_at

2. **ClientState** (1 –∑–∞–ø–∏—Å—å):
   - client_id (FK)
   - features (JSON, –≤—Å–µ –ø—Ä–∏–∑–Ω–∞–∫–∏)
   - features_hash (SHA256)
   - income_pred (float)
   - model_version

3. **PredictionLog** (1 –∑–∞–ø–∏—Å—å):
   - client_id (FK)
   - is_simulation = false
   - features (JSON –∫–æ–ø–∏—è)
   - income_pred (float –∫–æ–ø–∏—è)
   - explanation_json (SHAP –¥–∞–Ω–Ω—ã–µ)
   - text_explanation (–≥–æ—Ç–æ–≤–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ)
   - recommendations (JSON —Å —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏)
   - model_version
   - request_source = "csv_import"

4. **ImportJob** (1 –∑–∞–ø–∏—Å—å - –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è):
   - processed_rows ++ (–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏)
   - status (queued ‚Üí running ‚Üí completed)

---

## üîç–í–°–ï –û–®–ò–ë–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–´

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:

1. ‚úÖ **model.py –ø—É—Ç–∏** 
   - –ë—ã–ª–æ: `os.path("ml", "filename")` (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å)
   - –¢–µ–ø–µ—Ä—å: `Path(__file__).parent / "income_prediction_model.pkl"`

2. ‚úÖ **XGBoost –æ–±—Ä–∞–±–æ—Ç–∫–∞**
   - –ë—ã–ª–æ: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤, –∑–∞–±—ã—Ç feature_names
   - –¢–µ–ø–µ—Ä—å: `xgb.DMatrix(X_row, feature_names=feature_names)`

3. ‚úÖ **SHAP —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**
   - –ë—ã–ª–æ: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å XGBoost 3.x –∏ SHAP 0.49
   - –¢–µ–ø–µ—Ä—å: Try/except —Å fallback –Ω–∞ –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

4. ‚úÖ **ORM –º–æ–¥–µ–ª–∏ –≤ models.py**
   - –ë—ã–ª–∏: –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∫–æ–ø–∏–∏ ML –º–æ–¥–µ–ª–∏
   - –¢–µ–ø–µ—Ä—å: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ SQLAlchemy ORM –º–æ–¥–µ–ª–∏

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–í–°–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ –†–ê–ë–û–¢–ê–Æ–¢ –ö–û–†–†–ï–ö–¢–ù–û:**

```
CSV —Ñ–∞–π–ª
   ‚Üì
POST /api/imports/income-csv
   ‚Üì
ImportJob (status=queued)
   ‚Üì
process_import_job() [—Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞]
   ‚Üì
–î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏:
  ‚îú‚îÄ canonicalize_features()
  ‚îú‚îÄ Client.get_or_create()
  ‚îú‚îÄ model.predict()  ‚Üê ML –ú–û–î–ï–õ–¨ (‚úÖ –†–ê–ë–û–¢–ê–ï–¢)
  ‚îú‚îÄ PredictionLog.create()
  ‚îú‚îÄ ClientState.update()
  ‚îî‚îÄ compute_recommendations()
   ‚Üì
ImportJob (status=completed)
   ‚Üì
GET /api/clients/{external_id}/card
   ‚Üì
CardResponse —Å –ø—Ä–æ–≥–Ω–æ–∑–æ–º –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
```

**–ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å CSV ‚Üí –≤—Å–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!**
